name: deploy
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set image tags
        env:
          ACR_HOST: crpi-vvd63gd4gtn8gczl.cn-hangzhou.personal.cr.aliyuncs.com
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
        run: |
          echo "ACR_HOST=$ACR_HOST" >> $GITHUB_ENV
          echo "ACR_NAMESPACE=$ACR_NAMESPACE" >> $GITHUB_ENV
          echo "BACKEND_IMAGE=$ACR_HOST/$ACR_NAMESPACE/smartmix-backend:latest" >> $GITHUB_ENV
          echo "WEB_IMAGE=$ACR_HOST/$ACR_NAMESPACE/smartmix-web:latest" >> $GITHUB_ENV

      - name: Login ACR (instance domain via shell)
        env:
          ACR_HOST: crpi-vvd63gd4gtn8gczl.cn-hangzhou.personal.cr.aliyuncs.com
        run: |
          echo "Login ACR: $ACR_HOST"
          echo "${{ secrets.ACR_PASSWORD }}" | docker login "$ACR_HOST" -u "${{ secrets.ACR_USERNAME }}" --password-stdin

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.BACKEND_IMAGE }}

      - name: Build and push web
        uses: docker/build-push-action@v5
        with:
          context: ./web
          push: true
          tags: ${{ env.WEB_IMAGE }}

  deploy_ecs:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          script: |
            set -e
            ACR_HOST="crpi-vvd63gd4gtn8gczl.cn-hangzhou.personal.cr.aliyuncs.com"
            ACR_NAMESPACE="${{ secrets.ACR_NAMESPACE }}"
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}"
            DOMAIN_API="${{ secrets.DOMAIN_API }}"
            DOMAIN_APP="${{ secrets.DOMAIN_APP }}"
            MYSQL_PASSWORD="${{ secrets.MYSQL_PASSWORD }}"

            BACKEND_IMAGE="$ACR_HOST/$ACR_NAMESPACE/smartmix-backend:latest"
            WEB_IMAGE="$ACR_HOST/$ACR_NAMESPACE/smartmix-web:latest"

            mkdir -p "$PROJECT_DIR/deploy" "$PROJECT_DIR/deploy/caddy"

            {
              echo "SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/smartmix?useSSL=false&serverTimezone=Asia/Shanghai"
              echo "SPRING_DATASOURCE_USERNAME=${{ secrets.MYSQL_USER }}"
              echo "SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}"
              echo "SPRING_REDIS_HOST=redis"
              echo "SPRING_REDIS_PORT=6379"
              echo "APP_JWT_SECRET=${{ secrets.APP_JWT_SECRET }}"
              echo "ERP_WEBHOOK_TOKEN=${{ secrets.ERP_WEBHOOK_TOKEN }}"
            } > "$PROJECT_DIR/deploy/.env.production"

            {
              echo "${DOMAIN_API} {"
              echo "  encode gzip"
              echo "  route /api* {"
              echo "    uri strip_prefix /api"
              echo "    reverse_proxy backend:8080"
              echo "  }"
              echo "  reverse_proxy web:80"
              echo "}"
              echo ""
              echo "${DOMAIN_APP} {"
              echo "  encode gzip"
              echo "  reverse_proxy web:80"
              echo "}"
            } > "$PROJECT_DIR/deploy/caddy/Caddyfile"

            {
              echo "services:"
              echo "  backend:"
              echo "    image: ${BACKEND_IMAGE}"
              echo "    env_file: deploy/.env.production"
              echo "    restart: unless-stopped"
              echo "  web:"
              echo "    image: ${WEB_IMAGE}"
              echo "    restart: unless-stopped"
              echo "  mysql:"
              echo "    image: mysql:8.0"
              echo "    environment:"
              echo "      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}"
              echo "    volumes:"
              echo "      - mysql_data:/var/lib/mysql"
              echo "    restart: unless-stopped"
              echo "  redis:"
              echo "    image: redis:7-alpine"
              echo "    restart: unless-stopped"
              echo "  caddy:"
              echo "    image: caddy:2"
              echo "    container_name: smartmix-caddy"
              echo "    volumes:"
              echo "      - ./deploy/caddy/Caddyfile:/etc/caddy/Caddyfile"
              echo "      - caddy_data:/data"
              echo "      - caddy_config:/config"
              echo "    ports:"
              echo "      - \"80:80\""
              echo "      - \"443:443\""
              echo "    depends_on:"
              echo "      - backend"
              echo "      - web"
              echo "    restart: unless-stopped"
              echo "volumes:"
              echo "  mysql_data:"
              echo "  caddy_data:"
              echo "  caddy_config:"
            } > "$PROJECT_DIR/deploy/docker-compose.prod.yml"

            cd "$PROJECT_DIR"
            docker compose -f deploy/docker-compose.prod.yml pull
            docker compose -f deploy/docker-compose.prod.yml up -d
