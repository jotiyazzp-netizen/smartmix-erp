name: deploy
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy_ecs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Upload project to server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          source: "deploy/**,backend/**,web/**"
          target: ${{ secrets.PROJECT_DIR }}
          overwrite: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          script: |
            set -e
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}"
            DOMAIN_API_RAW="${{ secrets.DOMAIN_API }}"
            DOMAIN_APP_RAW="${{ secrets.DOMAIN_APP }}"
            DOMAIN_ROOT_RAW="${{ secrets.DOMAIN_ROOT }}"
            DOMAIN_API_HOST="$(echo "$DOMAIN_API_RAW" | sed -E 's#^https?://##; s#/*$##')"
            DOMAIN_APP_HOST="$(echo "$DOMAIN_APP_RAW" | sed -E 's#^https?://##; s#/*$##')"
            DOMAIN_ROOT_HOST="$(echo "$DOMAIN_ROOT_RAW" | sed -E 's#^https?://##; s#/*$##')"
            MYSQL_PASSWORD="${{ secrets.MYSQL_PASSWORD }}"
            GIT_REPO_URL="https://github.com/jotiyazzp-netizen/smartmix-erp.git"

            ufw status || true
            ufw allow 80/tcp || true
            ufw allow 443/tcp || true
            docker stop $(docker ps -q --filter name=smartmix-nginx) 2>/dev/null || true
            docker stop $(docker ps -q --filter name=smartmix-backend) 2>/dev/null || true
            mkdir -p "$PROJECT_DIR"

            {
              echo "SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/smartmix?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai"
              echo "SPRING_DATASOURCE_USERNAME=root"
              echo "SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}"
              echo "SPRING_REDIS_HOST=redis"
              echo "SPRING_REDIS_PORT=6379"
              echo "SPRING_PROFILES_ACTIVE=prod"
              echo "APP_JWT_SECRET=${{ secrets.APP_JWT_SECRET }}"
              echo "ERP_WEBHOOK_TOKEN=${{ secrets.ERP_WEBHOOK_TOKEN }}"
            } > "$PROJECT_DIR/deploy/.env.production"

            # Fallback: generate strong APP_JWT_SECRET if not provided
            if [ -z "${{ secrets.APP_JWT_SECRET }}" ]; then
              echo "No APP_JWT_SECRET provided in Secrets. Generating a strong one..."
              RAND=$(head -c 64 /dev/urandom | od -An -tx1 | tr -d ' \n')
              sed -i "s/^APP_JWT_SECRET=.*/APP_JWT_SECRET=${RAND}/" "$PROJECT_DIR/deploy/.env.production"
            fi

            # Provide Compose-level environment for variable substitution
            {
              echo "SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}"
            } > "$PROJECT_DIR/deploy/.env"

            cd "$PROJECT_DIR/deploy"
            docker compose -f docker-compose.prod.yml down || true
            docker volume rm mysql_data 2>/dev/null || true
            docker compose -f docker-compose.prod.yml up -d --build

            sleep 60
            ERP_TOKEN="${{ secrets.ERP_WEBHOOK_TOKEN }}"
            if [ -n "$ERP_TOKEN" ]; then
              curl -s -X POST -H "X-ERP-TOKEN: $ERP_TOKEN" "http://${DOMAIN_API_HOST}/api/auth/reset-admin" || true
            fi
            curl -I --max-time 10 "http://${DOMAIN_API_HOST}/swagger-ui.html" || true
            curl -I --max-time 10 "http://${DOMAIN_APP_HOST}/" || true
            if [ -n "$DOMAIN_ROOT_HOST" ]; then curl -I --max-time 10 "http://${DOMAIN_ROOT_HOST}/" || true; fi
            docker compose -f docker-compose.prod.yml ps
            docker compose -f docker-compose.prod.yml logs nginx --tail=200 || true
            docker compose -f docker-compose.prod.yml logs backend --tail=300 || true
