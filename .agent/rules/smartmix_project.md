---
trigger: always_on
---

---

trigger: smartmix_project
description: SmartMix 智能生产与成本执行系统 Workspace 规则（SAP ERP 风格 + 技术功能框图 + 阶段一 MVP）
---

你当前在一个名为 **SmartMix** 的项目 Workspace 中工作。  
SmartMix 的定位：在现有 **SAP 风格 ERP 系统** 之上，作为「生产与成本执行大脑」，专注混凝土生产端的：

- 动态配比管理；
- 实时成本优化；
- 生产任务与调度执行；
- 投料与过磅数据采集及成本闭环（后续阶段）。

本 Workspace 中所有代码、配置和文档，必须遵守本规则。

---

## 一、业务蓝图（完全对应技术功能框图）

### 1. A 区：现有 ERP 系统（SAP 风格）

淡黄色大框标题：**现有ERP系统**。包含以下模块：

- **A1：采购模块（MM / MM-PUR）**  
  - 管理物料主数据与采购业务。  

- **A2：材料主数据与价格**（位于采购模块下方）  
  - 包含：物料编码 MATNR、工厂 WERKS、基本计量单位 MEINS（KG/T 等）、物料描述、规格；  
  - 包含：采购价格（价格条件，按物料/工厂/供应商/币种/生效日期记录）。

- **A3：销售模块（SD）**  
  - 管理客户、销售订单和项目。  

- **A4：生产任务**（位于销售模块下方）  
  - 由销售订单/项目生成的生产任务（可类比生产订单/工单）。

- **A5：ERP 核心数据库（FI/CO）**（右下椭圆，对应图中的 A5）  
  - FI-GL：总账；  
  - CO：成本控制与项目/订单成本核算。

> ERP 继续负责：  
>
> - 基础物料管理（材料编码、名称、单位、规格）；  
> - 供应商管理与采购订单；  
> - 客户管理与销售订单/项目（生产任务来源）；  
> - 财务核算与总账（FI/CO）。

### 2. B 区：新系统 · 智能生产核心

淡黄色大框标题：**新系统：智能生产核心**。内部三个模块：

- **B1：动态配比库**  
  - 存储混凝土配比方案，类似 SAP PP-PI 中的配方/配方版本；  
  - 每条配比包括：强度等级（C30 等）、坍落度、特殊技术要求、材料清单及单方用量（kg/m³）；  
  - 状态：待审核(PENDING_APPROVAL)、已审核(APPROVED)、已停用(DISABLED)；  
  - 支持复制配比（基于已有配比快速创建新版本）。

- **B2：成本优化引擎**  
  - 从 B1 中读取配比，从 A2 获取材料单价；  
  - 按公式计算：  
    - 单方材料成本 = Σ(材料单价 × 单方用量)；  
    - 总成本 = 单方成本 × 方量；  
  - 对所有符合条件的配比按单方成本升序排序，选出“最低成本推荐配比”；  
  - 后续通过 C 区实际数据做理论 vs 实际偏差分析。

- **B3：生产调度**  
  - 接收 ERP 推送的生产任务（A4 → B3），或在新系统手工创建任务；  
  - 基于 B2 的推荐结果为任务选定配比；  
  - 记录理论材料消耗和理论成本；  
  - 输出 PDF 任务单（阶段一）。

### 3. C 区：生产现场

淡黄色大框标题：**生产现场**。内部模块：

- **C2：地磅**  
- **C1：搅拌楼控制**  
- **C3：车辆**

> 阶段一：通过 PDF 任务单 + 人工录入协同；  
> 阶段二：通过接口与 C1/C2 集成，采集实际数据，并下发配比。

### 4. 箭头与数据流（与图中箭头一致）

1. **A1 → A2**：采购模块 → 材料主数据与价格（维护、更新）。  
2. **A3 → A4**：销售模块 → 生产任务（由订单/项目生成任务）。

3. **A2 -- 同步材料价格 --> B2**  
   - ERP -> 新系统：材料主数据与价格 → 成本优化引擎；  
   - 代表 SAP MM 通过接口实时推送材料价格。

4. **A4 -- 同步生产任务 --> B3**  
   - ERP -> 新系统：生产任务 → 生产调度；  
   - 代表 SAP SD/PP 将任务（任务号、工程、强度等级、方量等）实时推送给新系统。

5. **B1 → B2**  
   - 动态配比库 → 成本优化引擎；  
   - 成本引擎需要配比中的材料清单和单方用量。

6. **B2 -- 下发优化配比 --> C1**  
   - 成本优化引擎 → 搅拌楼控制；  
   - 阶段一为 PDF 任务单 + 人工录入，阶段二为接口一键下发。

7. **C1 & C2 -- 采集实际数据 --> B2**  
   - 生产现场（搅拌楼控制、地磅） → 成本优化引擎；  
   - 阶段二开始采集实际投料与过磅数据，传回 B2 做偏差分析。

8. **B2 -- 同步理论消耗与成本 --> A5**  
   - 成本优化引擎 → ERP 核心数据库；  
   - 阶段三中，将理论材料消耗和成本回写 SAP FI/CO，用于正式成本核算与采购计划。

---

## 二、阶段一（MVP）范围——四个固定模块

阶段一目标：**在 2 个月内上线一个独立运行的 Web 系统**，仅实现以下四个功能模块，通过“人工决策 + 手工下发”即可获得明显成本收益。

### 模块一：ERP 数据同步（ERP → 新系统）

- **功能**：从 ERP 自动获取材料主数据（编码、名称）和最新采购单价，以及生产任务数据；  
- **方式**：ERP 通过 HTTP/HTTPS Webhook 实时推送，非新系统主动拉取。  

- **同步内容**（三类）：

  1. 材料主数据：  
     - 材料编码（MATNR）；  
     - 材料名称；  
     - 规格；  
     - 单位（MEINS，如 KG/T）；  
     - 工厂（WERKS，可选）。

  2. 材料价格：  
     - 材料编码；  
     - 工厂；  
     - 生效日期；  
     - 采购单价（元/吨或元/公斤）；  
     - 币种；  
     - 来源系统（例如 SAP-MM）。

  3. 生产任务：  
     - 生产任务单号；  
     - 工程名称；  
     - 强度等级；  
     - 方量（m³）；  
     - 坍落度要求；  
     - 特殊技术要求；  
     - 可选：SAP 销售订单号、生产订单号。

- **要求**：  
  - 后端记录每次同步日志（方向/类型/payload/状态/错误信息）；  
  - Web 前端可查看当前生效材料价格和同步日志；  
  - 验收 1：在 ERP 更新一个材料价格后，将其推送到新系统，新系统中的成本推荐结果要随之更新。

### 模块二：智能配比库管理（动态配比库 B1）

- **功能**：实验室人员在 Web 上管理所有配比方案。  

- **数据结构**：

  - 基础信息：  
    - 配比编号；  
    - 强度等级（如 C30）；  
    - 坍落度；  
    - 创建人；  
    - 创建时间；  
    - 状态（待审核 / 已审核 / 已停用）。

  - 材料清单：  
    - 材料编码；  
    - 材料名称；  
    - 单方用量（kg/m³）。

- **核心逻辑**：  
  - 配比只有处于“已审核(Approved)”状态时，才能被生产任务调用、参与成本计算；  
  - 支持“复制配比”：基于现有配比复制出新配比，初始状态为“待审核”；  
  - 验收 2：实验室成功创建、审核一个新的 C30 配比，并可在生产任务中使用。

### 模块三：成本优化推荐引擎（成本优化引擎 B2）

- **触发**：用户选择/输入一个生产任务（强度等级 + 方量）；  

- **系统自动执行**：

  1. 从状态为“已审核”的配比中筛选出所有符合该强度等级的配比；  
  2. 结合当前生效材料单价，计算每个配比的 **单方材料成本**：  
     - 单方材料成本 = Σ(材料单价 × 单方用量)；  
  3. 计算 **总成本**：单方成本 × 方量；  
  4. 按单方材料成本从低到高排序；  
  5. 列表顶部的配比标记为“最低成本推荐”。

- **显示信息**：  
  - 配比编号；  
  - 各材料单方用量（kg/m³）；  
  - 单方成本；  
  - 总成本（单方成本 × 方量）。  

- **验收 3**：  
  - 创建一个 C30 生产任务后，系统正确列出所有 C30 配比；  
  - 成本最低的配比被清楚标识为推荐方案。

### 模块四：生产任务与模拟下发（生产调度 B3）

- **功能**：  
  - 用户可创建/查看生产任务；  
  - 从推荐列表中选定配比；  
  - 生成清晰的 PDF 任务单，模拟“配比下发”动作。

- **任务信息**：  
  - 任务号；  
  - 工程名称；  
  - 强度等级；  
  - 需求方量；  
  - 坍落度要求；  
  - 特殊技术要求；  
  - 创建时间；  
  - 来源（ERP / 手工）。

- **模拟下发流程**：  
  1. 用户在 Web 中创建或选择一条任务；  
  2. 调用成本推荐引擎获取所有可用配比；  
  3. 从推荐列表中选中一个配比，点击“确认并生成任务单”；  
  4. 系统计算每种材料的总用量（单方用量 × 方量），以及整体成本；  
  5. 生成 PDF 任务单，其中包括：  
     - 任务基本信息；  
     - 所选配比编号与材料清单（单方用量 + 总用量）；  
     - 单方成本与总成本；  
  6. PDF 任务单可以打印或发送给搅拌楼操作员，由其手工录入到现有搅拌楼控制系统。

- **验收 4**：  
  - 能成功生成包含所有必要字段且版式清晰的 PDF 任务单。

---

## 三、技术栈与统一架构（后端 / Web / 移动 / 部署）

1. **后端**：Java 17 + Spring Boot 3.x + MySQL/PG + Redis + Maven。  
2. **Web 前端**：Vite + Vue 3 + TypeScript + Ant Design Vue / Element Plus。  
3. **移动端**：Flutter，一个代码仓库构建 Android APK 和 iOS IPA。  
4. **部署**：Docker / K8s，Nginx 作网关/反向代理。在阿里云 ECS 上运行，可使用阿里云 RDS/云 Redis。

所有前端（Web、Android、iOS）通过 HTTP/HTTPS 调用一个统一的后端 API 服务，访问同一个数据库。

---

## 四、ERP / 现场系统集成原则（SAP 风格）

1. **ERP → 新系统**  
   - 通过 ERP（或中间件，如 SAP PI/CPI）调用 SmartMix 暴露的 `/api/erp/...` 接口进行实时或批量推送；  
   - SmartMix 不得直接访问 ERP 数据库或定时拉取 ERP 接口。

2. **新系统 ↔ 生产现场**  
   - 阶段一仅通过 PDF + 人工方式与现场协同；  
   - 阶段二开始实现与地磅/搅拌楼控制/车辆系统的接口；  
   - 所有现场数据通过 HTTP/HTTPS 接入 SmartMix，不直接写数据库。

3. **新系统 → ERP 核心数据库**  
   - 阶段三实现理论材料消耗与成本回写 ERP，用于正式成本核算与采购计划；  
   - 阶段一仅在接口与实体上预留占位（如 `/api/erp/theoretical-consumption` 等）。

---

## 五、Antigravity 中模型与 Workflows 使用规则

1. **模型选择**

   - 后端 / Flutter / 部署相关命令：在 Workspace 对话框中选择 **Claude Sonnet 4.5 (Thinking)** 模型；  
   - Web 前端相关命令：在 Workspace 对话框中选择 **Gemini 3 Pro (High)** 模型。

2. **可用 Workflows（斜杠命令）**

   - `/init-smartmix-project`：初始化目录与架构文档；  
   - `/gen-backend-mvp`：生成后端（Java + Spring Boot + SAP 风格 ERP 集成）；  
   - `/gen-web-mvp`：生成 Web 管理后台（Vue 3 + TS + AntD / Element）；  
   - `/gen-mobile-shell`：生成 Flutter 移动端壳子（Android + iOS）；  
   - `/gen-devops-stack`：生成 Docker / docker-compose / Nginx / K8s 等部署配置。

> 所有 Workflows 必须遵守本规则文件中的技术栈、目录规范、阶段一范围和 SAP 风格 ERP 集成约束。
