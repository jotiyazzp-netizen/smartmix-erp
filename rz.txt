/usr/bin/docker run --name e5a34f4e5d8763f9a848e7814b9aabc8bb794c_8c90bf --label e5a34f --workdir /github/workspace --rm -e "INPUT_HOST" -e "INPUT_USERNAME" -e "INPUT_KEY" -e "INPUT_SCRIPT" -e "INPUT_PORT" -e "INPUT_PASSPHRASE" -e "INPUT_PASSWORD" -e "INPUT_SYNC" -e "INPUT_USE_INSECURE_CIPHER" -e "INPUT_CIPHER" -e "INPUT_TIMEOUT" -e "INPUT_COMMAND_TIMEOUT" -e "INPUT_KEY_PATH" -e "INPUT_FINGERPRINT" -e "INPUT_PROXY_HOST" -e "INPUT_PROXY_PORT" -e "INPUT_PROXY_USERNAME" -e "INPUT_PROXY_PASSWORD" -e "INPUT_PROXY_PASSPHRASE" -e "INPUT_PROXY_TIMEOUT" -e "INPUT_PROXY_KEY" -e "INPUT_PROXY_KEY_PATH" -e "INPUT_PROXY_FINGERPRINT" -e "INPUT_PROXY_CIPHER" -e "INPUT_PROXY_USE_INSECURE_CIPHER" -e "INPUT_SCRIPT_STOP" -e "INPUT_ENVS" -e "INPUT_ENVS_FORMAT" -e "INPUT_DEBUG" -e "INPUT_ALLENVS" -e "HOME" -e "GITHUB_JOB" -e "GITHUB_REF" -e "GITHUB_SHA" -e "GITHUB_REPOSITORY" -e "GITHUB_REPOSITORY_OWNER" -e "GITHUB_REPOSITORY_OWNER_ID" -e "GITHUB_RUN_ID" -e "GITHUB_RUN_NUMBER" -e "GITHUB_RETENTION_DAYS" -e "GITHUB_RUN_ATTEMPT" -e "GITHUB_ACTOR_ID" -e "GITHUB_ACTOR" -e "GITHUB_WORKFLOW" -e "GITHUB_HEAD_REF" -e "GITHUB_BASE_REF" -e "GITHUB_EVENT_NAME" -e "GITHUB_SERVER_URL" -e "GITHUB_API_URL" -e "GITHUB_GRAPHQL_URL" -e "GITHUB_REF_NAME" -e "GITHUB_REF_PROTECTED" -e "GITHUB_REF_TYPE" -e "GITHUB_WORKFLOW_REF" -e "GITHUB_WORKFLOW_SHA" -e "GITHUB_REPOSITORY_ID" -e "GITHUB_TRIGGERING_ACTOR" -e "GITHUB_WORKSPACE" -e "GITHUB_ACTION" -e "GITHUB_EVENT_PATH" -e "GITHUB_ACTION_REPOSITORY" -e "GITHUB_ACTION_REF" -e "GITHUB_PATH" -e "GITHUB_ENV" -e "GITHUB_STEP_SUMMARY" -e "GITHUB_STATE" -e "GITHUB_OUTPUT" -e "RUNNER_OS" -e "RUNNER_ARCH" -e "RUNNER_NAME" -e "RUNNER_ENVIRONMENT" -e "RUNNER_TOOL_CACHE" -e "RUNNER_TEMP" -e "RUNNER_WORKSPACE" -e "ACTIONS_RUNTIME_URL" -e "ACTIONS_RUNTIME_TOKEN" -e "ACTIONS_CACHE_URL" -e "ACTIONS_RESULTS_URL" -e GITHUB_ACTIONS=true -e CI=true -v "/var/run/docker.sock":"/var/run/docker.sock" -v "/home/runner/work/_temp/_github_home":"/github/home" -v "/home/runner/work/_temp/_github_workflow":"/github/workflow" -v "/home/runner/work/_temp/_runner_file_commands":"/github/file_commands" -v "/home/runner/work/smartmix-erp/smartmix-erp":"/github/workspace" e5a34f:4e5d8763f9a848e7814b9aabc8bb794c
======CMD======
set -e
PROJECT_DIR="***"
DOMAIN_API_RAW="***"
DOMAIN_APP_RAW="***"
DOMAIN_ROOT_RAW="***"
DOMAIN_API_HOST="$(echo "$DOMAIN_API_RAW" | sed -E 's#^https?://##; s#/*$##')"
DOMAIN_APP_HOST="$(echo "$DOMAIN_APP_RAW" | sed -E 's#^https?://##; s#/*$##')"
DOMAIN_ROOT_HOST="$(echo "$DOMAIN_ROOT_RAW" | sed -E 's#^https?://##; s#/*$##')"
MYSQL_PASSWORD="***"
GIT_REPO_URL="https://github.com/jotiyazzp-netizen/smartmix-erp.git"

ufw status || true
ufw allow 80/tcp || true
ufw allow 443/tcp || true
docker stop $(docker ps -q --filter name=smartmix-nginx) 2>/dev/null || true
docker stop $(docker ps -q --filter name=smartmix-backend) 2>/dev/null || true
mkdir -p "$PROJECT_DIR"

{
  echo "SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/smartmix?useSSL=false&serverTimezone=Asia/Shanghai"
  echo "SPRING_DATASOURCE_USERNAME=***"
  echo "SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}"
  echo "SPRING_REDIS_HOST=redis"
  echo "SPRING_REDIS_PORT=6379"
  echo "SPRING_PROFILES_ACTIVE=prod"
  echo "APP_JWT_SECRET=***"
  echo "ERP_WEBHOOK_TOKEN=***"
} > "$PROJECT_DIR/deploy/.env.production"

# Provide Compose-level environment for variable substitution
{
  echo "SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}"
} > "$PROJECT_DIR/deploy/.env"

cd "$PROJECT_DIR/deploy"
docker compose -f docker-compose.prod.yml down || true
docker volume rm mysql_data 2>/dev/null || true
docker compose -f docker-compose.prod.yml up -d --build

sleep 20
curl -I --max-time 10 "http://${DOMAIN_API_HOST}/swagger-ui.html" || true
curl -I --max-time 10 "http://${DOMAIN_APP_HOST}/" || true
if [ -n "$DOMAIN_ROOT_HOST" ]; then curl -I --max-time 10 "http://${DOMAIN_ROOT_HOST}/" || true; fi
docker compose -f docker-compose.prod.yml ps
docker compose -f docker-compose.prod.yml logs nginx --tail=100 || true
docker compose -f docker-compose.prod.yml logs backend --tail=100 || true
======END======
out: Status: inactive
out: Skipping adding existing rule
out: Skipping adding existing rule (v6)
out: Skipping adding existing rule
out: Skipping adding existing rule (v6)
err:  Container smartmix-nginx  Stopping
err:  Container smartmix-nginx  Stopped
err:  Container smartmix-nginx  Removing
err:  Container smartmix-nginx  Removed
err:  Container deploy-web-1  Stopping
err:  Container deploy-backend-1  Stopping
err:  Container deploy-backend-1  Stopped
err:  Container deploy-backend-1  Removing
err:  Container deploy-backend-1  Removed
err:  Container deploy-mysql-1  Stopping
err:  Container deploy-redis-1  Stopping
err:  Container deploy-web-1  Stopped
err:  Container deploy-web-1  Removing
err:  Container deploy-web-1  Removed
err:  Container deploy-redis-1  Stopped
err:  Container deploy-redis-1  Removing
err:  Container deploy-redis-1  Removed
err:  Container deploy-mysql-1  Stopped
err:  Container deploy-mysql-1  Removing
err:  Container deploy-mysql-1  Removed
err:  Network deploy_default  Removing
err:  Network deploy_default  Removed
out: #1 [internal] load local bake definitions
out: #1 reading from stdin 883B done
out: #1 DONE 0.0s
out: #2 [backend internal] load build definition from Dockerfile
out: #2 transferring dockerfile: 454B done
out: #2 DONE 0.0s
out: #3 [web internal] load build definition from Dockerfile
out: #3 transferring dockerfile: 302B done
out: #3 DONE 0.0s
out: #4 [web internal] load metadata for docker.io/library/nginx:alpine
out: #4 DONE 0.1s
out: #5 [web internal] load metadata for docker.io/library/node:22-alpine
out: #5 ...
out: #6 [backend internal] load metadata for docker.io/library/eclipse-temurin:17-jre
out: #6 DONE 0.3s
out: #5 [web internal] load metadata for docker.io/library/node:22-alpine
out: #5 DONE 0.3s
out: #7 [web internal] load .dockerignore
out: #7 transferring context: 2B done
out: #7 DONE 0.0s
out: #8 [web internal] load build context
out: #8 transferring context: 124.33kB 0.0s done
out: #8 DONE 0.0s
out: #9 [web build 1/6] FROM docker.io/library/node:22-alpine@sha256:b2358485e3e33bc3a33114d2b1bdb18cdbe4df01bd2b257198eb51beb1f026c5
out: #9 resolve docker.io/library/node:22-alpine@sha256:b2358485e3e33bc3a33114d2b1bdb18cdbe4df01bd2b257198eb51beb1f026c5 0.0s done
out: #9 DONE 0.0s
out: #10 [web stage-1 1/4] FROM docker.io/library/nginx:alpine@sha256:eb05700fe7baa6890b74278e39b66b2ed1326831f9ec3ed4bdc6361a4ac2f333
out: #10 resolve docker.io/library/nginx:alpine@sha256:eb05700fe7baa6890b74278e39b66b2ed1326831f9ec3ed4bdc6361a4ac2f333 0.0s done
out: #10 DONE 0.0s
out: #11 [web stage-1 3/4] COPY --from=build /app/dist .
out: #11 CACHED
out: #12 [web build 6/6] RUN npm run build
out: #12 CACHED
out: #13 [web build 3/6] COPY package*.json ./
out: #13 CACHED
out: #14 [web build 4/6] RUN npm install
out: #14 CACHED
out: #15 [web build 2/6] WORKDIR /app
out: #15 CACHED
out: #16 [web stage-1 2/4] WORKDIR /usr/share/nginx/html
out: #16 CACHED
out: #17 [web build 5/6] COPY . .
out: #17 CACHED
out: #18 [web stage-1 4/4] COPY nginx.conf /etc/nginx/conf.d/default.conf
out: #18 CACHED
out: #19 [web] exporting to image
out: #19 exporting layers done
out: #19 exporting manifest sha256:6db1cbd50ef78b00dc9959bb4a930cb7be3c86339c63a1987521f79e3f99c997 done
out: #19 exporting config sha256:d63ae7c71450ab803638aacd7b0d5047761823641b25d5015a56ba8512e031a0 done
out: #19 exporting attestation manifest sha256:092e416916f8775c569685c35052aaf2b8a060cf24540c2afb6310d4055a61f5 0.0s done
out: #19 exporting manifest list sha256:d6edc456e55ce4cce198d52c787d960aa1c59df50d7542b84b9d5e63d0c613ac
out: #19 exporting manifest list sha256:d6edc456e55ce4cce198d52c787d960aa1c59df50d7542b84b9d5e63d0c613ac 0.0s done
out: #19 naming to docker.io/library/deploy-web:latest done
out: #19 unpacking to docker.io/library/deploy-web:latest 0.0s done
out: #19 DONE 0.1s
out: #20 [web] resolving provenance for metadata file
out: #20 DONE 0.0s
out: #21 [backend internal] load metadata for docker.io/library/maven:3.9-eclipse-temurin-17
out: #21 DONE 1.1s
out: #22 [backend internal] load .dockerignore
out: #22 transferring context: 2B done
out: #22 DONE 0.0s
out: #23 [backend build 1/5] FROM docker.io/library/maven:3.9-eclipse-temurin-17@sha256:e4a7ace3dc0d645ed97f8d9ad0b0d3f0b14fa8d150138f27f116d7105a639b82
out: #23 resolve docker.io/library/maven:3.9-eclipse-temurin-17@sha256:e4a7ace3dc0d645ed97f8d9ad0b0d3f0b14fa8d150138f27f116d7105a639b82 0.0s done
out: #23 DONE 0.0s
out: #24 [backend stage-1 1/4] FROM docker.io/library/eclipse-temurin:17-jre@sha256:75ab7d1b4b18483e9245342cbee253b558952c1def5c1c18956196330a01683e
out: #24 resolve docker.io/library/eclipse-temurin:17-jre@sha256:75ab7d1b4b18483e9245342cbee253b558952c1def5c1c18956196330a01683e 0.0s done
out: #24 DONE 0.0s
out: #25 [backend stage-1 2/4] WORKDIR /app
out: #25 CACHED
out: #26 [backend internal] load build context
out: #26 transferring context: 106.09kB 0.0s done
out: #26 DONE 0.0s
out: #27 [backend build 2/5] WORKDIR /app
out: #27 CACHED
out: #28 [backend build 3/5] COPY pom.xml .
out: #28 CACHED
out: #29 [backend build 4/5] COPY src ./src
out: #29 CACHED
out: #30 [backend build 5/5] RUN mvn clean package -DskipTests
out: #30 CACHED
out: #31 [backend stage-1 3/4] RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
out: #31 0.601 Get:1 http://security.ubuntu.com/ubuntu noble-security InRelease [126 kB]
out: #31 0.657 Get:2 http://archive.ubuntu.com/ubuntu noble InRelease [256 kB]
out: #31 1.569 Get:3 http://security.ubuntu.com/ubuntu noble-security/main amd64 Packages [1,659 kB]
out: #31 1.792 Get:4 http://archive.ubuntu.com/ubuntu noble-updates InRelease [126 kB]
out: #31 2.076 Get:5 http://archive.ubuntu.com/ubuntu noble-backports InRelease [126 kB]
out: #31 2.365 Get:6 http://archive.ubuntu.com/ubuntu noble/multiverse amd64 Packages [331 kB]
out: #31 2.676 Get:7 http://archive.ubuntu.com/ubuntu noble/main amd64 Packages [1,808 kB]
out: #31 2.746 Get:8 http://security.ubuntu.com/ubuntu noble-security/restricted amd64 Packages [2,732 kB]
out: #31 3.069 Get:9 http://security.ubuntu.com/ubuntu noble-security/universe amd64 Packages [1,174 kB]
out: #31 3.163 Get:10 http://security.ubuntu.com/ubuntu noble-security/multiverse amd64 Packages [33.1 kB]
out: #31 3.196 Get:11 http://archive.ubuntu.com/ubuntu noble/universe amd64 Packages [19.3 MB]
out: #31 4.627 Get:12 http://archive.ubuntu.com/ubuntu noble/restricted amd64 Packages [117 kB]
out: #31 4.629 Get:13 http://archive.ubuntu.com/ubuntu noble-updates/restricted amd64 Packages [2,925 kB]
out: #31 4.762 Get:14 http://archive.ubuntu.com/ubuntu noble-updates/multiverse amd64 Packages [35.9 kB]
out: #31 4.764 Get:15 http://archive.ubuntu.com/ubuntu noble-updates/main amd64 Packages [2,050 kB]
out: #31 4.932 Get:16 http://archive.ubuntu.com/ubuntu noble-updates/universe amd64 Packages [1,942 kB]
out: #31 5.068 Get:17 http://archive.ubuntu.com/ubuntu noble-backports/universe amd64 Packages [33.9 kB]
out: #31 5.070 Get:18 http://archive.ubuntu.com/ubuntu noble-backports/main amd64 Packages [49.4 kB]
out: #31 5.860 Fetched 34.8 MB in 6s (6,150 kB/s)
out: #31 5.860 Reading package lists...
out: #31 6.867 Reading package lists...
out: #31 7.855 Building dependency tree...
out: #31 8.064 Reading state information...
out: #31 8.302 curl is already the newest version (8.5.0-2ubuntu10.6).
out: #31 8.302 0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
out: #31 DONE 8.4s
out: #32 [backend stage-1 4/4] COPY --from=build /app/target/smartmix-backend-*.jar /app/smartmix-backend.jar
out: #32 DONE 0.4s
out: #33 [backend] exporting to image
out: #33 exporting layers
out: #33 exporting layers 3.1s done
out: #33 exporting manifest sha256:fdbe40a727435346dfa32c8cfabf396bb51b6c32774510a0371d9d7e92dab583 0.0s done
out: #33 exporting config sha256:61a7b5ad1b17bdb89aca4c1123c89b02f68f1ab2b105fba39daed23905ede3e6 0.0s done
out: #33 exporting attestation manifest sha256:9259f30d058172b7e385274109451d02c90c8da013360f34bf9669e26b240540 0.0s done
out: #33 exporting manifest list sha256:3fe1938652726333ba0bcfc935994639b1f92b34f70c674cac674fb8143d8942 0.0s done
out: #33 naming to docker.io/library/deploy-backend:latest done
out: #33 unpacking to docker.io/library/deploy-backend:latest
out: #33 unpacking to docker.io/library/deploy-backend:latest 0.4s done
out: #33 DONE 3.6s
out: #34 [backend] resolving provenance for metadata file
out: #34 DONE 0.0s
err:  deploy-web  Built
err:  deploy-backend  Built
err:  Network deploy_default  Creating
err:  Network deploy_default  Created
err:  Container deploy-mysql-1  Creating
err:  Container deploy-redis-1  Creating
err:  Container deploy-web-1  Creating
err:  Container deploy-web-1  Created
err:  Container deploy-mysql-1  Created
err:  Container deploy-redis-1  Created
err:  Container deploy-backend-1  Creating
err:  Container deploy-backend-1  Created
err:  Container smartmix-nginx  Creating
err:  Container smartmix-nginx  Created
err:  Container deploy-mysql-1  Starting
err:  Container deploy-web-1  Starting
err:  Container deploy-redis-1  Starting
err:  Container deploy-redis-1  Started
err:  Container deploy-mysql-1  Started
err:  Container deploy-mysql-1  Waiting
err:  Container deploy-web-1  Started
err:  Container deploy-mysql-1  Healthy
err:  Container deploy-backend-1  Starting
err:  Container deploy-backend-1  Started
err:  Container deploy-backend-1  Waiting
err:  Container deploy-backend-1  Error
err: dependency failed to start: container deploy-backend-1 is unhealthy
2025/11/23 17:53:39 Process exited with status 1